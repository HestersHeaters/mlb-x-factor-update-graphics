name: Restore & Smoke (macOS + Windows)

on:
  push:
    branches: [ "**" ]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"
      - "build/diff/**"
      - "build/baselines/**"
      - "outputs/**"
  pull_request:
    branches: [ "**" ]

permissions: read-all

jobs:
  smoke:
    name: "Restore & Smoke (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest, windows-latest ]

    concurrency:
      group: ci-${{ github.workflow }}-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: true

    env:
      CI: "true"
      GITHUB_ACTIONS: "true"
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List repo root and data
        shell: pwsh
        run: |
          "PWD:"; Get-Location
          Get-ChildItem -Force
          "--- data/ ---"
          if (Test-Path "data") { Get-ChildItem -Force "data" } else { "no data/ dir" }

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3"
          use-public-rspm: true
          windows-path-include-rtools: true
          rtools-version: "42"

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      # ---- Plain renv restore (NO cache) ----
      - name: Install renv
        shell: Rscript {0}
        run: |
          install.packages("renv", repos = "https://packagemanager.posit.co/cran/latest")

      - name: Assert renv.lock R matches CI R (major.minor)
        shell: Rscript {0}
        run: |
          if (!requireNamespace("jsonlite", quietly = TRUE)) install.packages("jsonlite", repos = "https://packagemanager.posit.co/cran/latest")
          lock <- jsonlite::fromJSON("renv.lock")$R$Version
          ci <- as.character(getRversion())
          split <- function(x) strsplit(x, ".", fixed = TRUE)[[1]]
          ci_mm <- paste(split(ci)[1], split(ci)[2], sep=".")
          lk_mm <- paste(split(lock)[1], split(lock)[2], sep=".")
          cat("CI R:", ci, "\nLockfile R:", lock, "\n")
          if (ci_mm != lk_mm) stop(sprintf("R mismatch: CI %s vs lockfile %s", ci, lock))

      - name: renv::restore()
        shell: Rscript {0}
        run: |
          renv::activate(".")
          renv::restore(prompt = FALSE, clean = TRUE)

      # Only assert data on default branch of your main repo (replace OWNER)
      - name: Assert Excel files exist (main repo default branch only)
        if: >
          github.repository_owner == 'OWNER' &&
          github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        shell: Rscript {0}
        run: |
          fs <- c(
            "data/team_data_x_factor_update.xlsx",
            "data/hitter_data_x_factor_update.xlsx",
            "data/pitcher_data_x_factor_update.xlsx"
          )
          print(setNames(file.exists(fs), fs))
          if (!all(file.exists(fs))) {
            missing <- paste(fs[!file.exists(fs)], collapse = "\n  - ")
            stop(paste("Missing expected Excel files:\n  -", missing))
          }

      - name: Bootstrap (post-restore)
        shell: Rscript {0}
        run: |
          source("bootstrap.R")

      - name: Session info
        shell: Rscript {0}
        run: |
          sessionInfo()

      - name: Preflight (allow ❌ in CI for data/assets)
        shell: Rscript {0}
        run: |
          try(source("preflight.R"), silent = TRUE)

      - name: Parse scripts (syntax check)
        shell: Rscript {0}
        run: |
          parse(file = "create_x_factor_update_graphics.R")
          parse(file = "render_x_factor_update_graphics.R")
          cat("✅ Parsed both scripts without syntax errors.\n")
